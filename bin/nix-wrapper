#!/usr/bin/env bash
# Generic wrapper for running commands inside nix develop.
# Symlink to this file with the name of the command you want to wrap.
# Example: ln -s nix-wrapper node

Yellow=$'\e[93m'
Reset=$'\e[0m'

# cue runs its arguments as a command after echoing them in yellow.
cue() {
  local output
  printf -v output '%q ' "$@"
  echo "$Yellow${output% }$Reset"

  "$@"
}

# Check if flake.nix exists in current directory or any ancestor
has_flake() {
  local dir="$PWD"
  while [[ "$dir" != "/" ]]; do
    [[ -f "$dir/flake.nix" ]] && return 0
    dir=$(dirname "$dir")
  done
  return 1
}

main() {
  asCalled=$(basename "$0")
  folder=$(cd "$(dirname "$0")"; pwd)

  # Find the real program, excluding our bin/ directory
  # empty if not found, but then exec fails with an error
  prog=$(type -Pa "$asCalled" | grep -v "^$folder/" | head -1)

  # IN_NIX_DEVELOP is set by flake.nix shellHook
  # Change to PROJECT_ROOT if defined and not currently there (useful for subprojects)
  (( IN_NIX_DEVELOP )) && [[ -n "$PROJECT_ROOT" && $PWD != "$PROJECT_ROOT" ]] &&
    cue cd "$PROJECT_ROOT" >&2

  # If already in nix develop, or no flake.nix found, run prog directly
  # Otherwise use nix develop to get the right environment
  if (( IN_NIX_DEVELOP )) || ! has_flake; then
    exec "$prog" "$@"
  else
    exec nix develop -c "$asCalled" "$@"
  fi
}

: ${IN_NIX_DEVELOP:=0}

set -eu
main "$@"
